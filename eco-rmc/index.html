<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USA Weekly KPI Report - Data Entry</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 8px; }
        h1 { font-size: 1rem; color: #333; text-align: center; }
        .main-container { display: flex; gap: 10px; }
        .form-container { width: 280px; background: white; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .chart-container { flex: 1; background: white; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .form-row { margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
        .form-row label { flex: 1; font-size: 0.7rem; color: #333; }
        .form-row input { width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.75rem; }
        button { width: 100%; padding: 6px; background: #255190; color: white; border: none; border-radius: 3px; font-size: 0.75rem; cursor: pointer; margin-top: 5px; }
        button:hover { background: #1a3d6e; }
        .week-selector { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        h2 { font-size: 0.8rem; margin-bottom: 8px; color: #255190; }
        canvas { max-width: 100% !important; max-height: 100% !important; }
        .status-message { margin-top: 5px; padding: 5px; border-radius: 3px; text-align: center; display: none; font-size: 0.7rem; }
        .status-message.success { background: #d4edda; color: #155724; display: block; }
    </style>
</head>
<body>
    <h1>USA Weekly KPI Report - Data Entry</h1>
    <div class="main-container">
        <div class="form-container">
            <form id="kpi-form">
                <div class="week-selector">
                    <h2>Select Week to Update</h2>
                    <div class="form-row">
                        <select id="whichWeek">
                            <option value="this">This Week</option>
                            <option value="last">Last Week</option>
                        </select>
                    </div>
                </div>
                <h2>Enter KPI Values</h2>
                <div class="form-row"><label>Condition Monitoring:</label><input type="number" id="condmon" min="0" required></div>
                <div class="form-row"><label>DP Monitoring:</label><input type="number" id="dpmon" min="0" required></div>
                <div class="form-row"><label>CAT Support:</label><input type="number" id="catsupport" min="0" required></div>
                <div class="form-row"><label>HVAC Support:</label><input type="number" id="hvacsupport" min="0" required></div>
                <div class="form-row"><label>Samsara Monitoring:</label><input type="number" id="samsara" min="0" required></div>
                <div class="form-row"><label>RCA Investigations (Hrs):</label><input type="number" id="rca" min="0" required></div>
                <div class="form-row"><label>Remote Support:</label><input type="number" id="remotesupport" min="0" required></div>
                <div class="form-row"><label>Remote Access:</label><input type="number" id="remoteaccess" min="0" required></div>
                <div class="form-row"><label>On-Site Support:</label><input type="number" id="onsitesupport" min="0" required></div>
                <div class="form-row"><label>Value Cases:</label><input type="number" id="valuecases" min="0" required></div>
                <button type="submit">Update Chart</button>
                <div id="statusMessage" class="status-message"></div>
            </form>
        </div>
        <div class="chart-container">
            <h2 id="chartTitle">This Week's KPI Data</h2>
            <canvas id="kpiChart"></canvas>
        </div>
    </div>
    <script>
        // Load from localStorage if available
        const storedLastWeek = localStorage.getItem('lastWeekData');
        const storedThisWeek = localStorage.getItem('thisWeekData');
        // Base data (fallback if nothing is stored)
        const lastWeekData = storedLastWeek ? JSON.parse(storedLastWeek) : {
            'CONDITION MONITORING': 31,
            'DP MONITORING': 224,
            'CAT SUPPORT': 24,
            'HVAC SUPPORT': 2,
            'SAMSARA MONITORING': 40,
            'RCA INVESTIGATIONS (IN HOURS)': 1,
            'REMOTE SUPPORT': 7,
            'REMOTE ACCESS': 3,
            'ON-SITE SUPPORT': 0,
            'VALUE CASES': 10
        };
        const thisWeekData = storedThisWeek ? JSON.parse(storedThisWeek) : {
            'CONDITION MONITORING': 10,
            'DP MONITORING': 62,
            'CAT SUPPORT': 2,
            'HVAC SUPPORT': 0,
            'SAMSARA MONITORING': 5,
            'RCA INVESTIGATIONS (IN HOURS)': 0,
            'REMOTE SUPPORT': 0,
            'REMOTE ACCESS': 0,
            'ON-SITE SUPPORT': 0,
            'VALUE CASES': 0
        };
        let selectedWeek = 'this';
        let currentData = { ...thisWeekData };
        // Initialize Chart
        const ctx = document.getElementById('kpiChart').getContext('2d');
        const valueLabelsPlugin = {
            id: 'valueLabelsPlugin',
            afterDatasetsDraw(chart) {
                const { ctx } = chart;
                const dataset = chart.data.datasets[0];
                const meta = chart.getDatasetMeta(0);
                ctx.save();
                ctx.font = 'bold 11px Arial';
                ctx.textBaseline = 'middle';
                meta.data.forEach((bar, index) => {
                    const value = dataset.data[index];
                    const isSmall = value < 5;
                    const x = isSmall ? bar.x + 6 : bar.x - 6;
                    const y = bar.y;
                    ctx.fillStyle = isSmall ? '#333' : '#fff';
                    ctx.textAlign = isSmall ? 'left' : 'right';
                    ctx.fillText(value, x, y);
                });
                ctx.restore();
            }
        };
        const kpiChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(currentData),
                datasets: [{
                    label: 'KPI Value',
                    data: Object.values(currentData),
                    backgroundColor: '#255190',
                    borderRadius: 3
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: {
                    x: { beginAtZero: true, grid: { color: '#eee' }, ticks: { font: { size: 10 } } },
                    y: { grid: { display: false }, ticks: { font: { size: 10 } } }
                }
            },
            plugins: [valueLabelsPlugin]
        });
        const fieldMapping = {
            'condmon': 'CONDITION MONITORING',
            'dpmon': 'DP MONITORING',
            'catsupport': 'CAT SUPPORT',
            'hvacsupport': 'HVAC SUPPORT',
            'samsara': 'SAMSARA MONITORING',
            'rca': 'RCA INVESTIGATIONS (IN HOURS)',
            'remotesupport': 'REMOTE SUPPORT',
            'remoteaccess': 'REMOTE ACCESS',
            'onsitesupport': 'ON-SITE SUPPORT',
            'valuecases': 'VALUE CASES'
        };
        function populateForm() {
            for (const [fieldId, dataKey] of Object.entries(fieldMapping)) {
                document.getElementById(fieldId).value = currentData[dataKey];
            }
        }
        function updateChart() {
            kpiChart.data.datasets[0].data = Object.values(currentData);
            kpiChart.update();
        }
        function updateTitle() {
            const title = selectedWeek === 'this' ? "This Week's KPI Data" : "Last Week's KPI Data";
            document.getElementById('chartTitle').textContent = title;
        }
        function showStatus(message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message success';
            setTimeout(() => { statusEl.className = 'status-message'; }, 3000);
        }
        document.getElementById('whichWeek').addEventListener('change', function () {
            selectedWeek = this.value;
            currentData = selectedWeek === 'this' ? { ...thisWeekData } : { ...lastWeekData };
            populateForm();
            updateChart();
            updateTitle();
        });
        document.getElementById('kpi-form').addEventListener('submit', function (e) {
            e.preventDefault();
            for (const [fieldId, dataKey] of Object.entries(fieldMapping)) {
                currentData[dataKey] = Number(document.getElementById(fieldId).value);
            }
            if (selectedWeek === 'this') {
                Object.assign(thisWeekData, currentData);
            } else {
                Object.assign(lastWeekData, currentData);
            }
            localStorage.setItem('thisWeekData', JSON.stringify(thisWeekData));
            localStorage.setItem('lastWeekData', JSON.stringify(lastWeekData));
            updateChart();
            const weekName = selectedWeek === 'this' ? 'This Week' : 'Last Week';
            showStatus(`${weekName} updated!`);
        });
        // Initialize form and title
        populateForm();
        updateTitle();
    </script>
</body>
</html>
