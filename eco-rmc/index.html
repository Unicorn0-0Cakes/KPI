<script>
    // Try to load from localStorage first ///////////////////
    const storedLastWeek = localStorage.getItem('lastWeekData');
    const storedThisWeek = localStorage.getItem('thisWeekData');

    // ================================================
    // DATA STORAGE
    // ================================================
    const lastWeekData = storedLastWeek ? JSON.parse(storedLastWeek) : { ///////////////////
        'CONDITION MONITORING': 31,
        'DP MONITORING': 224,
        'CAT SUPPORT': 24,
        'HVAC SUPPORT': 2,
        'SAMSARA MONITORING': 40,
        'RCA INVESTIGATIONS (IN HOURS)': 1,
        'REMOTE SUPPORT': 7,
        'REMOTE ACCESS': 3,
        'ON-SITE SUPPORT': 0,
        'VALUE CASES': 10
    };

    const thisWeekData = storedThisWeek ? JSON.parse(storedThisWeek) : { ///////////////////
        'CONDITION MONITORING': 10,
        'DP MONITORING': 62,
        'CAT SUPPORT': 2,
        'HVAC SUPPORT': 0,
        'SAMSARA MONITORING': 5,
        'RCA INVESTIGATIONS (IN HOURS)': 0,
        'REMOTE SUPPORT': 0,
        'REMOTE ACCESS': 0,
        'ON-SITE SUPPORT': 0,
        'VALUE CASES': 0
    };
    // ================================================

    // Current active data
    let selectedWeek = 'this';
    let currentData = {...thisWeekData};

    // ... everything in between stays the same (chart, plugins, mapping, etc.) ...

    // Form submit handler
    document.getElementById('kpi-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Update currentData from form inputs
        for (const [fieldId, dataKey] of Object.entries(fieldMapping)) {
            currentData[dataKey] = Number(document.getElementById(fieldId).value);
        }
        
        // Save back to the appropriate week's data (in memory)
        if (selectedWeek === 'this') {
            Object.assign(thisWeekData, currentData);
        } else {
            Object.assign(lastWeekData, currentData);
        }

        // /////////////////// NEW: persist both week objects in localStorage
        localStorage.setItem('thisWeekData', JSON.stringify(thisWeekData));
        localStorage.setItem('lastWeekData', JSON.stringify(lastWeekData));
        // ///////////////////

        // Update the chart
        updateChart();
        
        // Show success message
        const weekName = selectedWeek === 'this' ? 'This Week' : 'Last Week';
        showStatus(`${weekName} updated!`);
    });

    // Initialize form with current data
    populateForm();
</script>
